{"mappings":"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","sources":["src/background/service_worker.ts","src/background/service_worker_scripts/index.ts","src/background/service_worker_scripts/applyTemplate.ts","src/background/service_worker_scripts/selectElements.ts","src/background/service_worker_scripts/sliceHtml.ts","src/background/service_worker_scripts/tracking.ts"],"sourcesContent":["import {\n    applyTemplate,\n    disableTracking,\n    enableTracking,\n    selectElements,\n    sliceHtml\n} from \"./service_worker_scripts\";\n\nconst scriptMap: Record<string, Function> = {\n    \"applyTemplate\": applyTemplate,\n    \"disableTracking\": disableTracking,\n    \"enableTracking\": enableTracking,\n    \"selectElements\": selectElements,\n    \"sliceHtml\": sliceHtml\n};\n\n/**\n * Executes a function in the context of the page corresponding to a tabId.\n * \n * @param tabId Specifies the tab in which to execute the function.\n * @param func A reference to a function to execute in the context of the page.\n * @param args Optional arguments to pass to the function.\n * @returns The result returned by the function. If the resulting value of the function execution is a promise, Chrome will wait for the promise to settle and return the resulting value. {@link https://developer.chrome.com/docs/extensions/reference/scripting/#promises}\n * @see {@link https://developer.chrome.com/docs/extensions/reference/scripting/#runtime-functions}\n */\nfunction executeScript<T = unknown>(tabId: number, func: () => void, ...args: any): Promise<T | void> {\n    return new Promise(resolve =>\n        chrome.scripting.executeScript(\n            { target: { tabId }, func, args },\n            results => {\n                // The results of executing JavaScript are passed to the extension. A single result is included per-frame. The main frame is guaranteed to be the first index in the resulting array; all other frames are in a non-deterministic order.\n                if (results instanceof Array && results.length > 0)\n                    resolve(results[0].result); // only take the first frame result for now\n                else if (chrome.runtime.lastError) // avoids error \"Unchecked runtime.lastError: Exactly one of 'func' and 'files' must be specified\"\n                    console.warn(chrome.runtime.lastError.message); // https://stackoverflow.com/questions/28431505/unchecked-runtime-lasterror-when-using-chrome-api\n                else\n                    resolve();\n            }\n        )\n    );\n}\n\n/**\n * Executes a script in the context of the page corresponding to a tabId.\n * Also used to inject a library such as jQuery so it can be called subsequently.\n * \n * @param tabId Specifies the tab in which to execute the script.\n * @param file A file containing the script to execute in the context of the page.\n * @returns The result returned by executing the script.\n * @see {@link https://developer.chrome.com/docs/extensions/reference/scripting/#runtime-functions}\n */\nfunction executeScriptFile<T = unknown>(tabId: number, file: string): Promise<T> {\n    return new Promise((resolve, reject) =>\n        chrome.scripting.executeScript(\n            { target: { tabId }, files: [file] },\n            results => {\n                // The results of executing JavaScript are passed to the extension. A single result is included per-frame. The main frame is guaranteed to be the first index in the resulting array; all other frames are in a non-deterministic order.\n                if (results instanceof Array && results.length > 0)\n                    resolve(results[0].result); // only take the first frame result for now\n                else if (chrome.runtime.lastError) // avoids error \"Unchecked runtime.lastError: Exactly one of 'func' and 'files' must be specified\"\n                    console.warn(chrome.runtime.lastError.message); // https://stackoverflow.com/questions/28431505/unchecked-runtime-lasterror-when-using-chrome-api\n                else\n                    reject({ message: `Failed to execute script file ${file}` });\n            }\n        )\n    );\n}\n\nasync function injectAll(tabId: number): Promise<void> {\n    const injected = await executeScript<boolean>(tabId, () => typeof window.syphonx === \"object\");\n    if (!injected) {\n        await executeScriptFile(tabId, \"jquery.slim.js\");\n        await executeScriptFile(tabId, \"syphonx.js\");\n        await chrome.scripting.insertCSS({ target: { tabId }, files: [\"sx.css\"] });\n        console.log(`BACKGROUND sx injected tabId=${tabId}`);\n    }\n}\n\nfunction waitForNavigation(): Promise<void> {\n    return new Promise<void>(resolve => {\n        function onCompleted(details: chrome.webNavigation.WebNavigationFramedCallbackDetails) {\n            if (details.frameId === 0) {\n                chrome.webNavigation.onCompleted.removeListener(onCompleted);\n                resolve();\n            }\n        }\n        chrome.webNavigation.onCompleted.addListener(onCompleted);\n    });\n}\n\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n    if (message.log) {\n        console.log(\"MESSAGE\", message.log);\n        return false; // immediate synchronous response\n    }\n\n    if (message.click) {\n        console.log(\"MESSAGE\", \"click\", { message, sender });\n        return false; // immediate synchronous response\n    }\n\n    if (typeof message.tabId !== \"number\") {\n        console.warn(\"MESSAGE\", message.key, { message, sender, error: `Property \"tabId\" is invalid: \"${message.tabId}\"` });\n        return false; // immediate synchronous response\n    }\n\n    if (message.key === \"navigate\") {\n        console.log(\"MESSAGE\", message.key, { message, sender });\n        (async () => {\n            await chrome.tabs.update({ url: message.params[0] });\n            await waitForNavigation();\n            sendResponse();\n        })();\n        return true; // response will be sent asynchronously\n    }\n    else if (message.key === \"reload\") {\n        console.log(\"MESSAGE\", message.key, { message, sender });\n        (async () => {\n            await chrome.tabs.reload();\n            await waitForNavigation();\n            sendResponse();\n        })();\n        return true; // response will be sent asynchronously\n    }\n    else if (message.key === \"tab\") {\n        (async () => {\n            const tab = await chrome.tabs.get(message.tabId);\n            sendResponse({ tab });\n            console.log(\"MESSAGE\", message.key, { message, sender, tab });\n        })();\n        return true; // response will be sent asynchronously\n    }\n    else if (!Object.keys(scriptMap).includes(message.key)) {\n        console.warn(\"MESSAGE\", { message, sender, error: `Property \"key\" is invalid: \"${message.key}\"` });\n        return false; // immediate synchronous response\n    }\n\n    (async () => {\n        try {\n            await injectAll(message.tabId);\n            const result = await executeScript(message.tabId, scriptMap[message.key] as () => void, ...message.params);\n            console.log(\"MESSAGE\", message.key, { message, sender, result });\n            sendResponse({ result });\n        }\n        catch (error) {\n            console.error(\"MESSAGE\", message.key, { message, sender, error });\n            sendResponse({ error });\n        }\n    })();\n\n    return true; // response will be sent asynchronously\n});\n\nconsole.log(\"BACKGROUND ready\");","export * from \"./applyTemplate\";\nexport * from \"./selectElements\";\nexport * from \"./sliceHtml\";\nexport * from \"./tracking\";\n","import { Template, ExtractResult } from \"syphonx-lib\";\n\nexport async function applyTemplate(template: Template): Promise<ExtractResult | undefined> {\n    const result = await syphonx.extract(template);\n    return result;\n}","export function selectElements(selectors: string[], limit = 100): Array<string | null> {\n    document.querySelectorAll(\".sx-select\").forEach(element =>\n        element.classList.remove(\"sx-select\"));\n\n    const result: Array<string | null> = [];\n    for (const selector of selectors)\n        if (selector && result.length <= limit)\n            document.querySelectorAll(selector).forEach(element => {\n                element.classList.add(\"sx-select\");\n                result.push(element.textContent);\n            });\n    return result;\n}","export function sliceHtml(upLimit = 3, downLimit = 3): string {\n    const elements = mark();\n    const output: string[] = [];\n    render(document.documentElement);\n    unmark();\n    return output.join(\"\\n\");\n\n    function mark(): Element[] {\n        const elements = Array.from(document.querySelectorAll(\".sx-click\"));\n        removeAllTrackingClasses();\n        for (const element of elements) {\n            element.setAttribute(\"marked\", \"\");\n            traverseUp(element);\n            if (element.parentElement)\n                traverseDown(element.parentElement);\n        }\n        return elements;\n    }\n\n    function removeAllTrackingClasses(): void {\n        removeTrackingClass(\"sx-click\");\n        removeTrackingClass(\"sx-hover\");\n        removeTrackingClass(\"sx-select\");\n    }\n\n    function removeTrackingClass(className: string): void {\n        document.querySelectorAll(`.${className}`).forEach(element => {\n            element.classList.remove(className);\n            if (element.classList.length === 0)\n                element.removeAttribute(\"class\");\n        });\n    }\n\n    function unmark(): void {\n        document.querySelectorAll(\"[marked]\").forEach(element => element.removeAttribute(\"marked\"));\n    }\n\n    function traverseUp(element: Element, n = 0): void {\n        if (element.parentElement && n <= upLimit) {\n            element.parentElement.setAttribute(\"marked\", \"\");\n            traverseUp(element.parentElement, n + 1);\n        }            \n    }\n    \n    function traverseDown(element: Element, level = Infinity, n = 0): void {\n        if (--level >= 0 && n <= downLimit) {\n            for (const child of element.children) {\n                child.setAttribute(\"marked\", \"\");\n                traverseDown(child, level, n + 1);\n            }\n        }\n    }\n\n    function render(element: Element): void {\n        const tag = element.tagName.toLowerCase();\n        const exclude = [\"noscript\", \"script\", \"style\", \"svg\"];\n        const container = ![\"area\", \"base\", \"br\", \"col\", \"embed\", \"hr\", \"img\", \"input\", \"link\", \"meta\", \"param\", \"source\", \"track\", \"wbr\"].includes(tag);\n        const attributes = renderAttributes(element.attributes);\n        const marked = element.hasAttribute(\"marked\");\n        if (elements.includes(element) && marked) {\n            output.push(`<!-- SELECT THE FOLLOWING ELEMENT -->`);\n        }\n        if (!container && marked) {\n            output.push(`<${tag}${attributes}>`);\n        }\n        else if (element.children.length > 0) {\n            if (marked)\n                output.push(`<${tag}${attributes}>`);\n            const children = Array.from(element.children)\n                .filter(child => !exclude.includes(child.tagName.toLocaleLowerCase()));\n            for (const child of children)\n                render(child);\n            if (marked)\n                output.push(`</${tag}>`);\n        }\n        else if (element.textContent !== null && element.textContent.trim().length > 0 && marked) {\n            const text = truncateText(element.textContent.trim().replace(/\\s+/gm, \" \"));\n            output.push(`<${tag}${attributes}>${text}</${tag}>`);\n        }\n        else if (marked) {\n            output.push(`<${tag}${attributes}></${tag}>`);\n        }\n    \n        function renderAttributes(attributes: NamedNodeMap): string {\n            const text = Array.from(element.attributes)\n                .filter(attr => attr.value && attr.name !== \"marked\")\n                .map(attr => `${attr.name}=\"${attr.value.replace(/\"/g,'\\\"')}\"`)\n                .join(\" \");\n            return text ? \" \" + text : \"\";\n        }\n    \n        function truncateText(text: string, max = 80): string {\n            if (text.length > max) {\n                const k = Math.floor(max / 2);\n                const i = Math.max(text.slice(0, k).lastIndexOf(\" \"), k);\n                const j = Math.max(k - text.slice(-k).indexOf(\" \"), k);\n                text = text.slice(0, i) + \" … \" + text.slice(-j);\n            }\n            return text;\n        }\n    }\n}","export function disableTracking(): void {\n    syphonx.tracking = false;\n\n    document.querySelectorAll(\".sx-hover\").forEach(element => {\n        element.classList.remove(\"sx-hover\");\n        if (element.classList.length === 0)\n            element.removeAttribute(\"class\");\n    });\n\n    document.querySelectorAll(\".sx-click\").forEach(element => {\n        element.classList.remove(\"sx-click\");\n        if (element.classList.length === 0)\n            element.removeAttribute(\"class\");\n    });\n\n    if (syphonx.reset) {\n        syphonx.reset();\n        syphonx.reset = undefined;\n    }\n}\n\nexport function enableTracking(): void {\n    syphonx.tracking = true;\n\n    syphonx.reset = () => {\n        document.removeEventListener(\"click\", onClick);\n        document.removeEventListener(\"auxclick\", onClick);\n        document.removeEventListener(\"contextmenu\", onContext);\n        document.removeEventListener(\"mousemove\", onMouseMove);\n    };\n\n    document.addEventListener(\"click\", onClick);\n    document.addEventListener(\"auxclick\", onClick);\n    document.addEventListener(\"contextmenu\", onContext);\n    document.addEventListener(\"mousemove\", onMouseMove);\n\n    function onClick(event: MouseEvent): void {\n        document.querySelectorAll(\".sx-click\").forEach(element => {\n            element.classList.remove(\"sx-click\");\n            if (element.classList.length === 0)\n                element.removeAttribute(\"class\");\n        });\n\n        document.querySelectorAll(\".sx-hover\").forEach(element => {\n            element.classList.remove(\"sx-hover\");\n            if (element.classList.length === 0)\n                element.removeAttribute(\"class\");\n        });\n\n        if (syphonx.tracking) {\n            if (event.target instanceof HTMLElement) {\n                event.target.classList.add(\"sx-click\");\n                chrome.runtime.sendMessage({ click: {\n                    altKey: event.altKey,\n                    button: event.button,\n                    ctrlKey: event.ctrlKey,\n                    shiftKey: event.shiftKey,\n                    x: event.x,\n                    y: event.y\n                } });\n            }\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    }\n\n    function onContext(event: MouseEvent): void {\n        event.preventDefault();\n    }\n\n    function onMouseMove(event: MouseEvent): void {\n        document.querySelectorAll(\".sx-hover\").forEach(element => {\n            element.classList.remove(\"sx-hover\");\n            if (element.classList.length === 0)\n                element.removeAttribute(\"class\");\n        });\n\n        if (syphonx.tracking)\n            if (event.target instanceof HTMLElement)\n                event.target.classList.add(\"sx-hover\");\n    }\n}\n"],"names":[],"version":3,"file":"service_worker.js.map"}